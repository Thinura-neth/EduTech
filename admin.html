<!DOCTYPE html>
<html lang="si">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - EduTech</title>
    <link rel="stylesheet" href="assets/css/styles.css">
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>
    <script src="firebase-config.js"></script>
</head>
<body>
    <div class="loading-bar"></div>
    
    <header class="header">
        <nav class="nav">
            <div class="logo">EduTech Admin</div>
            <ul class="nav-links">
                <li><a href="index.html">Home</a></li>
                <li><a href="dashboard.html">Dashboard</a></li>
                <li><a href="admin.html" id="adminLink" style="display: none;">Admin</a></li>
                <li><a href="login.html" id="loginLink">Login</a></li>
                <li><span class="user-welcome" id="userWelcome" style="display: none;"></span></li>
                <li><button class="logout-btn" onclick="logout()" style="display: none;">Logout</button></li>
            </ul>
        </nav>
    </header>

    <main class="container">
        <div id="accessDenied" class="access-denied" style="display: none;">
            <h2>ðŸš« Access Denied</h2>
            <p>You must be logged in as an administrator to view this page.</p>
            <a href="dashboard.html" class="btn mt-3">Go to Dashboard</a>
        </div>

        <section id="adminContent" style="display: none;">
            <div class="page-header">
                <h1>Admin Panel</h1>
                <p>Manage all marketplace advertisements.</p>
            </div>
            
            <div class="card">
                <h2>Marketplace Ad Management</h2>
                <div class="admin-table-section">
                    <table class="admin-table" id="adsTable">
                        <thead>
                            <tr><th>Status</th><th>Image</th><th>Title</th><th>Description</th><th>Price</th><th>Created</th><th>Actions</th></tr>
                        </thead>
                        <tbody>
                            <tr><td colspan="7" class="text-center text-muted">Loading ads...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </section>
    </main>
    
    <script src="assets/js/central-db.js"></script>
    <script src="assets/js/auth.js"></script>
    <script src="assets/js/realtime-ads.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function(){
            if (requireAdmin()) {
                document.getElementById('adminContent').style.display = 'block';
                
                function fmt(ts){ 
                    if(!ts) return ''; 
                    // ts is a firebase timestamp (ms since epoch)
                    var d=new Date(ts); 
                    return d.toLocaleString(); 
                }

                function getStatusClass(status) {
                    if (status === 'approved') return 'text-success';
                    if (status === 'pending') return 'text-warning';
                    if (status === 'rejected') return 'text-error';
                    return 'text-muted';
                }

                function load(){
                    // Fetch ALL ads for admin view
                    RealtimeAds.fetchAllAdsOnce().then(function(ads){
                        const tbody = document.querySelector('#adsTable tbody');
                        tbody.innerHTML = '';
                        
                        if (ads.length === 0) {
                            tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted">No ads found.</td></tr>';
                            return;
                        }

                        ads.forEach(ad=>{
                            const tr = document.createElement('tr');
                            tr.innerHTML = `
                                <td class="${getStatusClass(ad.status)}">${ad.status.toUpperCase()}</td>
                                <td><img src="${ad.imageUrl||'assets/images/placeholder-ad.png'}" width="80" onerror="this.onerror=null;this.src='assets/images/placeholder-ad.png';"></td>
                                <td>${ad.title||'N/A'}</td>
                                <td>${ad.description||'N/A'}</td>
                                <td>${ad.price||'N/A'}</td>
                                <td>${fmt(ad.created)}</td>
                                <td>
                                    <button data-id="${ad.id}" data-action="delete" class="btn-small logout-btn">Delete</button>
                                    ${ad.status !== 'approved' ? `<button data-id="${ad.id}" data-action="approve" class="btn-small btn-success mt-1">Approve</button>` : ''}
                                    ${ad.status !== 'rejected' ? `<button data-id="${ad.id}" data-action="reject" class="btn-small btn-secondary mt-1">Reject</button>` : ''}
                                </td>
                            `;
                            tbody.appendChild(tr);
                        });
                        
                        tbody.querySelectorAll('button[data-id]').forEach(btn=>{
                            btn.onclick = function(){ 
                                const id = btn.dataset.id;
                                const action = btn.dataset.action;
                                
                                if(action === 'delete'){
                                    if(confirm('Delete this ad?')){ 
                                        RealtimeAds.deleteAd(id)
                                            .then(() => { alert('Ad deleted!'); load(); })
                                            .catch(e => alert('Failed to delete: ' + e.message));
                                    }
                                } else if (action === 'approve') {
                                    if(confirm('Approve this ad?')){ 
                                        RealtimeAds.updateAdStatus(id, 'approved')
                                            .then(() => { alert('Ad approved!'); load(); })
                                            .catch(e => alert('Failed to approve: ' + e.message));
                                    }
                                } else if (action === 'reject') {
                                    if(confirm('Reject this ad?')){ 
                                        RealtimeAds.updateAdStatus(id, 'rejected')
                                            .then(() => { alert('Ad rejected!'); load(); })
                                            .catch(e => alert('Failed to reject: ' + e.message));
                                    }
                                }
                            };
                        });
                        
                    }).catch(e => {
                        console.error("Error loading ads:", e);
                        document.querySelector('#adsTable tbody').innerHTML = '<tr><td colspan="7" class="text-center text-error">Failed to load ads.</td></tr>';
                    });
                }
                
                load();
            }
        });
    </script>
</body>
</html>