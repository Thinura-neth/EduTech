<!DOCTYPE html>
<html lang="si">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - EduTech</title>
    <link rel="stylesheet" href="assets/css/styles.css">
</head>
<body>
    <div class="loading-bar"></div>
    
    <header class="header">
        <nav class="nav">
            <div class="logo">EduTech Dashboard</div>
            <ul class="nav-links">
                <li><a href="index.html">Home</a></li>
                <li><a href="dashboard.html">Dashboard</a></li>
                <li><a href="admin.html" id="adminLink" style="display: none;">Admin</a></li>
                <li><a href="login.html" id="loginLink">Login</a></li>
                <li><span class="user-welcome" id="userWelcome" style="display: none;"></span></li>
                <li><button class="logout-btn" onclick="logout()" style="display: none;">Logout</button></li>
            </ul>
        </nav>
    </header>

    <main class="container">
        <div id="authMessage" class="auth-message" style="display: none;">
            <div class="message-content">
                <h2>üîê Please Login to Access Dashboard</h2>
                <p>You need to be logged in to view your learning dashboard and access courses.</p>
                <a href="login.html" class="btn btn-primary">Login Now</a>
                <p class="text-muted mt-2">Don't have an account? <a href="login.html" style="color: #06b6d4;">Register here</a></p>
            </div>
        </div>

        <div id="dashboardContent" style="display: none;">
            <div class="dashboard-header">
                <h1>Welcome to Your Dashboard</h1>
                <p id="welcomeMessage">Manage your learning journey and track your progress</p>
            </div>

            <div class="dashboard-grid">
                <div class="main-content">
                    <div class="stats-card card">
                        <h3>üìä Your Learning Stats</h3>
                        <div class="stats-grid">
                            <div class="stat-item">
                                <div class="stat-number" id="enrolledCount">0</div>
                                <div class="stat-label">Courses Enrolled</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-number" id="progressAvg">0%</div>
                                <div class="stat-label">Average Progress</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-number" id="completedCount">0</div>
                                <div class="stat-label">Completed</div>
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <h3>üéØ Available Courses</h3>
                        <div class="courses-grid" id="coursesGrid">
                            <div class="loading-courses">Loading courses...</div>
                        </div>
                    </div>

                    <div class="card">
                        <h3>üîß Quick Access</h3>
                        <div class="quick-links">
                            <a href="education.html" class="quick-link">üìö Education</a>
                            <a href="courses.html" class="quick-link">üéì Courses</a>
                            <a href="services.html" class="quick-link">‚ö° Services</a>
                            <a href="pricing.html" class="quick-link">üí∞ Pricing</a>
                            <a href="gallery.html" class="quick-link">üñºÔ∏è Gallery</a>
                            <a href="blog.html" class="quick-link">üìù Blog</a>
                            <a href="contact.html" class="quick-link">üìû Contact</a>
                            <a href="admin.html" class="quick-link admin-link" style="display: none;">üîß Admin Panel</a>
                        </div>
                    </div>
                </div>

                <div class="sidebar">
                    <div class="card">
                        <h3>üìà Your Courses</h3>
                        <div id="userCourses">
                            <div class="loading-courses">Loading your courses...</div>
                        </div>
                    </div>

                    <div class="card">
                        <h3>‚ö° Quick Actions</h3>
                        <div class="action-buttons">
                            <button class="btn btn-primary" onclick="viewProfile()">View Profile</button>
                            <button class="btn btn-secondary" onclick="browseCourses()">Browse Courses</button>
                            <button class="btn btn-secondary" onclick="contactSupport()">Contact Support</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <footer class="footer">
        <p>&copy; 2024 EduTech. All rights reserved.</p>
    </footer>

    <script src="assets/js/database.js"></script>
    <script src="assets/js/auth.js"></script>
    <script>
        // Update dashboard stats
        async function updateDashboardStats() {
            const currentUser = getCurrentUser();
            if (!currentUser) return;

            try {
                const userCourses = await clientDB.getUserEnrolledCourses(currentUser.id);
                const enrolledCount = userCourses.length;
                const completedCount = userCourses.filter(course => course.progress_percentage === 100).length;
                const progressAvg = userCourses.length > 0 
                    ? Math.round(userCourses.reduce((sum, course) => sum + course.progress_percentage, 0) / userCourses.length)
                    : 0;

                document.getElementById('enrolledCount').textContent = enrolledCount;
                document.getElementById('completedCount').textContent = completedCount;
                document.getElementById('progressAvg').textContent = progressAvg + '%';
                
                console.log('Dashboard stats updated:', { enrolledCount, completedCount, progressAvg });
            } catch (error) {
                console.error('Error updating dashboard stats:', error);
                // Set default values if error
                document.getElementById('enrolledCount').textContent = '0';
                document.getElementById('completedCount').textContent = '0';
                document.getElementById('progressAvg').textContent = '0%';
            }
        }

        // Load available courses
        async function loadCourses() {
            const coursesGrid = document.getElementById('coursesGrid');
            
            try {
                console.log('Loading available courses...');
                const courses = await clientDB.getCourses();
                
                if (courses.length === 0) {
                    coursesGrid.innerHTML = '<p style="text-align: center; color: #94a3b8;">No courses available at the moment.</p>';
                    return;
                }

                console.log('Courses loaded:', courses.length);
                coursesGrid.innerHTML = courses.map(course => `
                    <div class="course-card">
                        <div class="course-icon">${course.image || 'üìö'}</div>
                        <div class="course-info">
                            <h4>${course.title}</h4>
                            <p>${course.description}</p>
                            <div class="course-meta">
                                <span>$${course.price}</span>
                                <span>${course.duration_hours}h</span>
                            </div>
                        </div>
                        <button class="btn btn-primary" onclick="enrollCourse(${course.id})">Enroll</button>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Error loading courses:', error);
                coursesGrid.innerHTML = '<p style="text-align: center; color: #ef4444;">Error loading courses. Please try again.</p>';
            }
        }

        // Load user's enrolled courses
        async function loadUserCourses() {
            const currentUser = getCurrentUser();
            if (!currentUser) return;

            const userCoursesContainer = document.getElementById('userCourses');
            
            try {
                console.log('Loading user courses for user:', currentUser.id);
                const userCourses = await clientDB.getUserEnrolledCourses(currentUser.id);
                
                console.log('User courses found:', userCourses.length);
                
                if (userCourses.length === 0) {
                    userCoursesContainer.innerHTML = `
                        <div class="no-courses">
                            <p style="text-align: center; color: #94a3b8;">No courses enrolled yet.</p>
                            <button class="btn btn-small" onclick="browseCourses()" style="margin-top: 1rem; width: 100%;">Browse Courses</button>
                        </div>
                    `;
                    return;
                }

                userCoursesContainer.innerHTML = userCourses.map(course => `
                    <div class="user-course-item">
                        <div class="course-title">${course.title}</div>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${course.progress_percentage}%"></div>
                        </div>
                        <div class="progress-text">${course.progress_percentage}% Complete</div>
                        <button class="btn btn-small" onclick="updateProgress(${course.id})" style="width: 100%;">Update Progress</button>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Error loading user courses:', error);
                userCoursesContainer.innerHTML = '<p style="text-align: center; color: #ef4444;">Error loading your courses.</p>';
            }
        }

        // Enroll in a course
        async function enrollCourse(courseId) {
            if (!isLoggedIn()) {
                alert('Please login first to enroll in courses.');
                window.location.href = 'login.html';
                return;
            }

            const currentUser = getCurrentUser();
            
            try {
                const courses = await clientDB.getCourses();
                const course = courses.find(c => c.id === courseId);
                
                if (!course) {
                    alert('Course not found.');
                    return;
                }

                const success = await clientDB.enrollUserInCourse(currentUser.id, courseId);
                
                if (success) {
                    alert(`‚úÖ Successfully enrolled in "${course.title}"!`);
                    await loadUserCourses();
                    await updateDashboardStats();
                } else {
                    alert('‚ö†Ô∏è You are already enrolled in this course.');
                }
            } catch (error) {
                console.error('Error enrolling in course:', error);
                alert('‚ùå Failed to enroll in course. Please try again.');
            }
        }

        // Update course progress
        async function updateProgress(courseId) {
            const currentUser = getCurrentUser();
            
            try {
                const userCourses = await clientDB.getUserEnrolledCourses(currentUser.id);
                const currentCourse = userCourses.find(course => course.id === courseId);
                
                if (!currentCourse) {
                    alert('Course not found in your enrollments.');
                    return;
                }
                
                const progress = prompt(`Enter your progress percentage (0-100) for "${currentCourse.title}":`, currentCourse.progress_percentage);
                
                if (progress !== null && progress >= 0 && progress <= 100) {
                    const success = await clientDB.updateCourseProgress(currentUser.id, courseId, parseInt(progress));
                    if (success) {
                        alert('‚úÖ Progress updated successfully!');
                        await loadUserCourses();
                        await updateDashboardStats();
                    } else {
                        alert('‚ùå Failed to update progress.');
                    }
                }
            } catch (error) {
                console.error('Error updating progress:', error);
                alert('‚ùå Error updating progress. Please try again.');
            }
        }

        // View user profile
        function viewProfile() {
            const user = getCurrentUser();
            if (user) {
                alert(`üë§ Profile Information:\n\nName: ${user.full_name || 'Not set'}\nEmail: ${user.email}\nRole: ${user.role}\nMember since: ${new Date(user.created_at).toLocaleDateString()}`);
            } else {
                alert('User information not available.');
            }
        }

        // Browse courses
        function browseCourses() {
            window.location.href = 'courses.html';
        }

        // Contact support
        function contactSupport() {
            window.location.href = 'contact.html';
        }

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('üè† Dashboard loading...');
            
            // Update navigation first
            updateNavigation();
            
            // Check if user is logged in
            if (!isLoggedIn()) {
                console.log('‚ùå User not logged in, showing auth message');
                document.getElementById('authMessage').style.display = 'block';
                document.getElementById('dashboardContent').style.display = 'none';
                return;
            }

            console.log('‚úÖ User is logged in, loading dashboard content');
            
            // User is logged in, show dashboard content
            document.getElementById('authMessage').style.display = 'none';
            document.getElementById('dashboardContent').style.display = 'block';
            
            // Update welcome message with user's name
            const user = getCurrentUser();
            if (user) {
                const welcomeMessage = document.getElementById('welcomeMessage');
                const userName = user.full_name || user.email.split('@')[0];
                welcomeMessage.textContent = `Welcome back, ${userName}! Manage your learning journey and track your progress.`;
                
                // Show admin link if user is admin
                if (user.role === 'admin') {
                    document.querySelector('.admin-link').style.display = 'block';
                    console.log('üîß Admin link shown');
                }
            }
            
            // Load dashboard content
            try {
                console.log('üìä Loading dashboard components...');
                await loadCourses();
                await loadUserCourses();
                await updateDashboardStats();
                console.log('‚úÖ Dashboard loaded successfully');
            } catch (error) {
                console.error('‚ùå Dashboard initialization error:', error);
                alert('Error loading dashboard. Please refresh the page.');
            }
        });

        // Debug function
        function debugDashboard() {
            console.log('=== DASHBOARD DEBUG ===');
            console.log('Current User:', getCurrentUser());
            console.log('Is Logged In:', isLoggedIn());
            console.log('LocalStorage:', {
                user_id: localStorage.getItem('user_id'),
                user_email: localStorage.getItem('user_email'),
                user_name: localStorage.getItem('user_name'),
                user_role: localStorage.getItem('user_role')
            });
        }
    </script>

    <style>
        .auth-message {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 60vh;
            text-align: center;
        }

        .message-content {
            background: rgba(255, 255, 255, 0.05);
            padding: 3rem;
            border-radius: 16px;
            border: 1px solid rgba(6, 182, 212, 0.3);
            max-width: 500px;
        }

        .message-content h2 {
            color: #06b6d4;
            margin-bottom: 1rem;
        }

        .dashboard-header {
            text-align: center;
            margin-bottom: 3rem;
            padding: 2rem 0;
        }

        .dashboard-header h1 {
            font-size: 2.5rem;
            margin-bottom: 1rem;
            background: linear-gradient(135deg, #06b6d4, #7c3aed);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 2rem;
            margin-top: 2rem;
        }

        @media (max-width: 768px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
        }

        .stats-card {
            background: linear-gradient(135deg, rgba(6, 182, 212, 0.1), rgba(124, 58, 237, 0.1));
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
            margin-top: 1rem;
        }

        @media (max-width: 768px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }
        }

        .stat-item {
            text-align: center;
            padding: 1.5rem 1rem;
        }

        .stat-number {
            font-size: 2.5rem;
            font-weight: bold;
            color: #06b6d4;
            margin-bottom: 0.5rem;
        }

        .stat-label {
            color: #94a3b8;
            font-size: 0.9rem;
        }

        .courses-grid {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            margin-top: 1rem;
        }

        .course-card {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1.5rem;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            transition: all 0.3s ease;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .course-card:hover {
            background: rgba(255, 255, 255, 0.08);
            transform: translateX(5px);
            border-color: rgba(6, 182, 212, 0.3);
        }

        .course-icon {
            font-size: 2rem;
            width: 60px;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(6, 182, 212, 0.1);
            border-radius: 12px;
            flex-shrink: 0;
        }

        .course-info {
            flex: 1;
        }

        .course-info h4 {
            margin-bottom: 0.5rem;
            color: #f1f5f9;
            font-size: 1.1rem;
        }

        .course-info p {
            color: #94a3b8;
            font-size: 0.9rem;
            margin-bottom: 0.5rem;
        }

        .course-meta {
            display: flex;
            gap: 1rem;
            font-size: 0.8rem;
            color: #64748b;
        }

        .quick-links {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 0.8rem;
            margin-top: 1rem;
        }

        .quick-link {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            padding: 1rem;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            text-decoration: none;
            color: #cbd5e1;
            text-align: center;
            transition: all 0.3s ease;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .quick-link:hover {
            background: rgba(6, 182, 212, 0.1);
            color: #06b6d4;
            transform: translateY(-2px);
            border-color: rgba(6, 182, 212, 0.3);
        }

        .user-course-item {
            padding: 1.5rem;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            margin-bottom: 1rem;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .course-title {
            font-weight: 500;
            margin-bottom: 1rem;
            color: #f1f5f9;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #334155;
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 0.5rem;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(135deg, #06b6d4, #7c3aed);
            border-radius: 4px;
            transition: width 0.5s ease;
        }

        .progress-text {
            font-size: 0.8rem;
            color: #94a3b8;
            text-align: center;
            margin-bottom: 1rem;
        }

        .action-buttons {
            display: flex;
            flex-direction: column;
            gap: 0.8rem;
        }

        .btn {
            display: inline-block;
            padding: 10px 20px;
            background: linear-gradient(135deg, #06b6d4, #7c3aed);
            color: white;
            text-decoration: none;
            border-radius: 6px;
            font-weight: bold;
            transition: all 0.3s ease;
            border: none;
            cursor: pointer;
            text-align: center;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(6, 182, 212, 0.3);
        }

        .btn-primary {
            background: linear-gradient(135deg, #06b6d4, #7c3aed);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #475569, #64748b);
        }

        .btn-small {
            padding: 8px 16px;
            font-size: 0.8rem;
        }

        .loading-courses {
            text-align: center;
            color: #94a3b8;
            padding: 2rem;
            font-style: italic;
        }

        .no-courses {
            text-align: center;
            padding: 2rem;
        }
    </style>
</body>
</html>